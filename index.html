<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fuel Consumption Dashboard</title>

  <!-- Fix global reference for some UMD builds -->
  <script>
    window.global = window;
  </script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Prop Types -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts (Stable UMD) -->
  <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

  <!-- Markdown Parser (Marked) for AI Response -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body {
      font-family: 'Sarabun', sans-serif;
    }

    .ai-gradient-text {
      background: linear-gradient(to right, #4f46e5, #9333ea);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ai-border {
      position: relative;
      background: #fff;
      padding: 2px;
      border-radius: 0.75rem;
    }

    .ai-border::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: 0.85rem;
      padding: 2px;
      background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
  </style>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, ComposedChart } = window.Recharts;

    // --- API Configuration ---
    // Normally provided by environment, but user can override in settings
    const apiKey = "";

    // --- Inline Icons (Lucide) ---
    const Icon = ({ children, color = "currentColor", size = 24, ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
        {children}
      </svg>
    );

    const Car = (props) => <Icon {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" /><circle cx="7" cy="17" r="2" /><circle cx="17" cy="17" r="2" /></Icon>;
    const Droplets = (props) => <Icon {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z" /><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97" /></Icon>;
    const Wallet = (props) => <Icon {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1" /><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4" /></Icon>;
    const Gauge = (props) => <Icon {...props}><path d="m12 14 4-4" /><path d="M3.34 19a10 10 0 1 1 17.32 0" /></Icon>;
    const Calendar = (props) => <Icon {...props}><path d="M8 2v4" /><path d="M16 2v4" /><rect width="18" height="18" x="3" y="4" rx="2" /><path d="M3 10h18" /></Icon>;
    const Filter = (props) => <Icon {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></Icon>;
    const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6" /></Icon>;
    const ChevronUp = (props) => <Icon {...props}><path d="m18 15-6-6-6 6" /></Icon>;
    const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></Icon>;
    const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></Icon>;
    const FileText = (props) => <Icon {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M10 9H8" /><path d="M16 13H8" /><path d="M16 17H8" /></Icon>;
    const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>;
    const CheckCircle2 = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></Icon>;
    const ListOrdered = (props) => <Icon {...props}><line x1="10" x2="21" y1="6" y2="6" /><line x1="10" x2="21" y1="12" y2="12" /><line x1="10" x2="21" y1="18" y2="18" /><path d="M4 6h1v4" /><path d="M4 10h2" /><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1" /></Icon>;
    const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></Icon>;
    const TrendingUp = (props) => <Icon {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></Icon>;
    const BarChart2 = (props) => <Icon {...props}><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></Icon>;
    const Sparkles = (props) => <Icon {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5H5" /><path d="M19 21v-4" /><path d="M15 19h4" /></Icon>;
    const X = (props) => <Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>;
    const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></Icon>;

    // --- Constants & Config ---
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_CbtEgFdOUWga3qSQq2hjdWgFIOTWVsGEK0ZdejWSLGb01td_JC7uITqtWQwLqXswGJcMqCSZpT0j/pub?gid=0&single=true&output=csv";

    // Mock Data for Fallback
    const MOCK_CSV = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°,‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ,‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡πâ‡∏ô,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏¥‡∏ï‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°,‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏•‡∏¥‡∏ï‡∏£
01/01/2567,Toyota Camry (‡∏Å‡∏Å-1234),120000,45.5,1600,35.16
05/01/2567,Honda CR-V (‡∏Ç‡∏Ç-5678),55000,52.0,1900,36.54
10/01/2567,Toyota Camry (‡∏Å‡∏Å-1234),120600,42.0,1500,35.71
15/01/2567,Isuzu D-Max (‡∏Ñ‡∏Ñ-9999),80000,60.0,2100,35.00
20/01/2567,Honda CR-V (‡∏Ç‡∏Ç-5678),55600,48.0,1750,36.46
25/01/2567,Toyota Camry (‡∏Å‡∏Å-1234),121100,38.0,1350,35.53
01/02/2567,Isuzu D-Max (‡∏Ñ‡∏Ñ-9999),80800,55.0,1950,35.45
05/02/2567,Toyota Camry (‡∏Å‡∏Å-1234),121650,44.0,1580,35.91
10/02/2567,Honda CR-V (‡∏Ç‡∏Ç-5678),56200,50.0,1820,36.40
15/02/2567,Isuzu D-Max (‡∏Ñ‡∏Ñ-9999),81600,62.0,2200,35.48
20/02/2567,Toyota Camry (‡∏Å‡∏Å-1234),122200,40.0,1450,36.25
25/02/2567,Honda CR-V (‡∏Ç‡∏Ç-5678),56800,51.0,1880,36.86
01/03/2567,Isuzu D-Max (‡∏Ñ‡∏Ñ-9999),82500,65.0,2300,35.38
05/03/2567,Toyota Camry (‡∏Å‡∏Å-1234),122700,41.0,1500,36.59
10/03/2567,Honda CR-V (‡∏Ç‡∏Ç-5678),57400,49.0,1800,36.73`;

    const COLORS = [
      '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
      '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#A855F7', '#64748B'
    ];

    const MONTH_NAMES = [
      "‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.",
      "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."
    ];

    // --- Utility Functions ---
    const splitCSV = (str) => {
      const result = [];
      let current = '';
      let inQuote = false;
      for (let i = 0; i < str.length; i++) {
        const char = str[i];
        if (char === '"') {
          inQuote = !inQuote;
        } else if (char === ',' && !inQuote) {
          result.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim().replace(/^"|"$/g, ''));
      return result;
    };

    const parseDate = (dateStr) => {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (!isNaN(d.getTime()) && dateStr.includes('-')) return d;

      const parts = dateStr.split(/[\/\-\.]/);
      if (parts.length === 3) {
        let year = parseInt(parts[2]);
        if (year > 2500) year -= 543;
        const month = parseInt(parts[1]) - 1;
        const day = parseInt(parts[0]);
        const thaiDate = new Date(year, month, day);
        if (!isNaN(thaiDate.getTime())) return thaiDate;
      }
      return d;
    };

    const cleanNumber = (str) => {
      if (typeof str === 'number') return str;
      if (!str) return 0;
      const cleaned = str.toString().replace(/,/g, '').replace(/[^\d.-]/g, '');
      return parseFloat(cleaned) || 0;
    };

    // --- Main Component ---
    function App() {
      const [rawData, setRawData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      // Filters State
      const [selectedVehicle, setSelectedVehicle] = useState('All');
      const [selectedYear, setSelectedYear] = useState('All');
      const [selectedMonth, setSelectedMonth] = useState('All');
      const [isDemoMode, setIsDemoMode] = useState(false);

      // Bottom Chart Tab State
      const [bottomTab, setBottomTab] = useState('cost_dist'); // 'cost_dist' | 'efficiency'

      const [isTableExpanded, setIsTableExpanded] = useState(false);

      // Pagination State
      const [currentPage, setCurrentPage] = useState(1);
      const itemsPerPage = 20;

      // Search State
      const [searchTerm, setSearchTerm] = useState('');

      // Debug State
      const [mappingDebug, setMappingDebug] = useState(null);
      const [showDebug, setShowDebug] = useState(false);

      // --- AI State ---
      const [showSettings, setShowSettings] = useState(false);
      const [userApiKey, setUserApiKey] = useState(apiKey || "");
      const [aiAnalysis, setAiAnalysis] = useState(null);
      const [isAiLoading, setIsAiLoading] = useState(false);
      const [aiError, setAiError] = useState(null);

      useEffect(() => {
        const processData = (text) => {
          try {
            const lines = text.split(/\r?\n/);
            if (lines.length < 2) throw new Error("CSV file is empty or invalid format");

            const headerLine = lines[0];
            const headers = splitCSV(headerLine).map(h => h.trim());
            const headersLower = headers.map(h => h.toLowerCase());

            const findIdx = (keywords, excludes = []) => {
              return headersLower.findIndex(h =>
                keywords.some(k => h.includes(k)) &&
                !excludes.some(e => h.includes(e))
              );
            };

            // Mapping Logic
            let dateIdx = findIdx(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°']);
            let vehicleIdx = findIdx(['‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ']);
            let odoIdx = findIdx(['‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏°‡πâ‡∏ô']);
            let literIdx = findIdx(['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏¥‡∏ï‡∏£']);
            let costIdx = findIdx(['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏°']);
            let pricePerLiterIdx = findIdx(['‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏•‡∏¥‡∏ï‡∏£']);

            // Fallback Mapping Logic
            if (dateIdx === -1) dateIdx = findIdx(['date', 'time', '‡∏ß‡∏±‡∏ô', '‡πÄ‡∏ß‡∏•‡∏≤']);
            if (vehicleIdx === -1) vehicleIdx = findIdx(['vehicle', 'car', 'plate', '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', '‡∏£‡∏ñ']);
            if (odoIdx === -1) odoIdx = findIdx(['odo', 'mile', '‡πÑ‡∏°‡∏•‡πå', '‡∏£‡∏∞‡∏¢‡∏∞', '‡∏Å‡∏¥‡πÇ‡∏•']);
            if (literIdx === -1) literIdx = findIdx(['liter', 'vol', '‡∏•‡∏¥‡∏ï‡∏£', '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì']);
            if (costIdx === -1) costIdx = findIdx(['cost', 'price', 'baht', '‡∏ö‡∏≤‡∏ó', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', '‡∏£‡∏≤‡∏Ñ‡∏≤'], ['‡∏ï‡πà‡∏≠', '/']);

            if (dateIdx === -1) dateIdx = 0;
            if (vehicleIdx === -1) vehicleIdx = 1;
            if (odoIdx === -1) odoIdx = 2;
            if (literIdx === -1) literIdx = 3;
            if (costIdx === -1) costIdx = 4;

            setMappingDebug({
              headers: headers,
              mapping: {
                date: { index: dateIdx, name: headers[dateIdx] || 'N/A' },
                vehicle: { index: vehicleIdx, name: headers[vehicleIdx] || 'N/A' },
                odometer: { index: odoIdx, name: headers[odoIdx] || 'N/A' },
                liters: { index: literIdx, name: headers[literIdx] || 'N/A' },
                cost: { index: costIdx, name: headers[costIdx] || 'N/A' },
                pricePerLiter: { index: pricePerLiterIdx, name: headers[pricePerLiterIdx] || 'N/A' }
              }
            });

            const parsedData = lines.slice(1).map((line, index) => {
              if (!line.trim()) return null;
              const row = splitCSV(line);
              if (row.length < 3) return null;

              const dateStr = row[dateIdx] || '';
              const dateObj = parseDate(dateStr);
              const vehicleStr = (row[vehicleIdx] || 'Unknown').trim();
              const odoVal = cleanNumber(row[odoIdx]);
              const literVal = cleanNumber(row[literIdx]);
              const costVal = cleanNumber(row[costIdx]);

              let pplVal = 0;
              if (pricePerLiterIdx !== -1) {
                pplVal = cleanNumber(row[pricePerLiterIdx]);
              } else if (literVal > 0) {
                pplVal = costVal / literVal;
              }

              const formattedDate = dateObj
                ? dateObj.toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' })
                : dateStr;

              const timestamp = dateObj ? dateObj.getTime() : 0;

              return {
                id: index,
                rawDate: dateStr,
                date: formattedDate,
                timestamp: timestamp,
                vehicle: vehicleStr,
                odometer: odoVal,
                liters: literVal,
                cost: costVal,
                pricePerLiter: parseFloat(pplVal.toFixed(2))
              };
            }).filter(item => item && item.liters > 0);

            setRawData(parsedData);
            setLoading(false);
            return true;
          } catch (err) {
            console.error("Processing error:", err);
            return false;
          }
        };

        const fetchData = async () => {
          try {
            setLoading(true);
            let response;
            try {
              response = await fetch(CSV_URL);
            } catch (e) {
              console.warn("Direct fetch failed (likely CORS/307), attempting Proxy...");
            }

            if (!response || !response.ok) {
              const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(CSV_URL)}`;
              response = await fetch(proxyUrl);
            }

            if (!response.ok) throw new Error('Network response was not ok');
            const text = await response.text();
            const success = processData(text);
            if (!success) throw new Error("Parsing failed");
            setIsDemoMode(false);
          } catch (err) {
            console.warn("Fetch failed, falling back to mock data:", err);
            setIsDemoMode(true);
            setError(null);
            processData(MOCK_CSV);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
      }, []);

      const processedData = useMemo(() => {
        const groupedByVehicle = {};
        rawData.forEach(item => {
          if (!groupedByVehicle[item.vehicle]) groupedByVehicle[item.vehicle] = [];
          groupedByVehicle[item.vehicle].push(item);
        });

        let allProcessed = [];

        Object.keys(groupedByVehicle).forEach(v => {
          const validOdoEntries = groupedByVehicle[v].filter(d => d.odometer > 0).sort((a, b) => a.odometer - b.odometer);

          const calculated = validOdoEntries.map((entry, index) => {
            let distance = 0;
            let kml = 0;

            if (index > 0) {
              const prevEntry = validOdoEntries[index - 1];
              distance = entry.odometer - prevEntry.odometer;
              if (distance < 0) distance = 0;

              if (entry.liters > 0 && distance > 0) {
                kml = distance / entry.liters;
              }
            }

            return { ...entry, distance, kml: parseFloat(kml.toFixed(2)) };
          });

          allProcessed = [...allProcessed, ...calculated];
        });

        return allProcessed.sort((a, b) => a.timestamp - b.timestamp);
      }, [rawData]);

      const { years, months } = useMemo(() => {
        const ySet = new Set();
        const mSet = new Set();
        rawData.forEach(d => {
          if (d.timestamp) {
            const date = new Date(d.timestamp);
            ySet.add(date.getFullYear());
            mSet.add(date.getMonth());
          }
        });
        return {
          years: Array.from(ySet).sort((a, b) => b - a),
          months: Array.from(mSet).sort((a, b) => a - b)
        };
      }, [rawData]);

      const filteredData = useMemo(() => {
        let data = processedData;
        if (selectedVehicle !== 'All') {
          data = data.filter(d => d.vehicle === selectedVehicle);
        }
        if (selectedYear !== 'All') {
          data = data.filter(d => {
            const date = new Date(d.timestamp);
            return date.getFullYear() === parseInt(selectedYear);
          });
        }
        if (selectedMonth !== 'All') {
          data = data.filter(d => {
            const date = new Date(d.timestamp);
            return date.getMonth() === parseInt(selectedMonth);
          });
        }
        return data;
      }, [processedData, selectedVehicle, selectedYear, selectedMonth]);

      const monthlyEfficiencyData = useMemo(() => {
        const groups = {};
        filteredData.forEach(item => {
          if (item.distance <= 0 || item.liters <= 0) return;
          const dateObj = new Date(item.timestamp);
          if (isNaN(dateObj.getTime())) return;

          const monthKey = dateObj.toLocaleDateString('th-TH', { month: 'short', year: '2-digit' });
          const sortKey = dateObj.getFullYear() * 100 + dateObj.getMonth();

          if (!groups[monthKey]) groups[monthKey] = { name: monthKey, sortKey: sortKey, vehicles: {} };

          const vName = item.vehicle;
          if (!groups[monthKey].vehicles[vName]) groups[monthKey].vehicles[vName] = { distance: 0, liters: 0 };

          groups[monthKey].vehicles[vName].distance += item.distance;
          groups[monthKey].vehicles[vName].liters += item.liters;
        });

        const result = Object.values(groups).map(group => {
          const row = { name: group.name, sortKey: group.sortKey };
          if (selectedVehicle === 'All') {
            const totalDist = Object.values(group.vehicles).reduce((sum, v) => sum + v.distance, 0);
            const totalLit = Object.values(group.vehicles).reduce((sum, v) => sum + v.liters, 0);
            row['Fleet Average'] = totalLit > 0 ? parseFloat((totalDist / totalLit).toFixed(2)) : 0;
          } else {
            Object.keys(group.vehicles).forEach(v => {
              const { distance, liters } = group.vehicles[v];
              row[v] = liters > 0 ? parseFloat((distance / liters).toFixed(2)) : 0;
            });
          }
          return row;
        });
        return result.sort((a, b) => a.sortKey - b.sortKey);
      }, [filteredData, selectedVehicle]);

      const chartVehicleKeys = useMemo(() => {
        if (selectedVehicle === 'All') return ['Fleet Average'];
        const keys = new Set();
        monthlyEfficiencyData.forEach(d => {
          Object.keys(d).forEach(k => {
            if (k !== 'name' && k !== 'sortKey') keys.add(k);
          });
        });
        return Array.from(keys);
      }, [monthlyEfficiencyData, selectedVehicle]);

      const allVehiclesList = useMemo(() => {
        return ['All', ...new Set(rawData.map(d => d.vehicle))];
      }, [rawData]);

      const getVehicleColor = (vehicleName) => {
        if (vehicleName === 'Fleet Average') return '#3B82F6';
        const index = allVehiclesList.indexOf(vehicleName);
        return COLORS[index % COLORS.length] || '#000';
      };

      const stats = useMemo(() => {
        const totalCost = filteredData.reduce((acc, curr) => acc + curr.cost, 0);
        const totalLiters = filteredData.reduce((acc, curr) => acc + curr.liters, 0);
        const totalDistance = filteredData.reduce((acc, curr) => acc + curr.distance, 0);
        const validRuns = filteredData.filter(d => d.distance > 0);
        const validDist = validRuns.reduce((acc, curr) => acc + curr.distance, 0);
        const validRunLiters = validRuns.reduce((acc, curr) => acc + curr.liters, 0);
        const avgKml = validRunLiters > 0 ? (validDist / validRunLiters) : 0;
        return { totalCost, totalLiters, totalDistance, avgKml };
      }, [filteredData]);

      // --- Updated Cost Distribution Data (Bar Chart: Top 5) ---
      const costByVehicleData = useMemo(() => {
        const costMap = {};
        filteredData.forEach(d => {
          const vName = d.vehicle || 'Unknown';
          if (!costMap[vName]) costMap[vName] = { value: 0, count: 0 };
          costMap[vName].value += d.cost;
          costMap[vName].count += 1;
        });

        let data = Object.keys(costMap)
          .map(key => ({ name: key, value: costMap[key].value }))
          .sort((a, b) => b.value - a.value);

        // Show only Top 5
        return data.slice(0, 5);
      }, [filteredData]);

      // --- Combined Data for Comparison (Switches based on Tab) ---
      const combinedStatsData = useMemo(() => {
        const map = {};
        filteredData.forEach(d => {
          const vName = d.vehicle || 'Unknown';
          if (!map[vName]) map[vName] = { cost: 0, distance: 0, liters: 0 };
          map[vName].cost += d.cost;
          map[vName].distance += (d.distance || 0);
          map[vName].liters += (d.liters || 0);
        });

        return Object.keys(map).map(key => ({
          name: key,
          cost: map[key].cost,
          distance: map[key].distance,
          liters: map[key].liters,
          // Metrics
          bpk: map[key].distance > 0 ? (map[key].cost / map[key].distance).toFixed(2) : 0,
          kml: map[key].liters > 0 ? parseFloat((map[key].distance / map[key].liters).toFixed(2)) : 0
        })).sort((a, b) => {
          if (bottomTab === 'efficiency') return b.kml - a.kml; // Sort by Efficiency
          return b.cost - a.cost; // Default sort by cost
        });
      }, [filteredData, bottomTab]);

      // --- Pagination Logic ---
      const sortedData = useMemo(() => {
        return [...filteredData].reverse(); // Show newest first
      }, [filteredData]);

      // --- Search & Filter Logic ---
      const searchedData = useMemo(() => {
        if (!searchTerm) return sortedData;
        const lowerTerm = searchTerm.toLowerCase();
        return sortedData.filter(item =>
          item.vehicle.toLowerCase().includes(lowerTerm) ||
          item.date.includes(lowerTerm) ||
          item.odometer.toString().includes(lowerTerm)
        );
      }, [sortedData, searchTerm]);

      const totalPages = Math.ceil(searchedData.length / itemsPerPage);

      const currentTableData = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return searchedData.slice(startIndex, startIndex + itemsPerPage);
      }, [searchedData, currentPage]);

      const goToPage = (page) => {
        if (page >= 1 && page <= totalPages) {
          setCurrentPage(page);
        }
      };

      // Reset page when filters or search change
      useEffect(() => {
        setCurrentPage(1);
      }, [selectedVehicle, selectedYear, selectedMonth, searchTerm]);

      // --- AI Feature Logic ---
      const generateAiInsight = async () => {
        const keyToUse = userApiKey;
        if (!keyToUse) {
          setAiError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ API Key ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏Å‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á)");
          setShowSettings(true);
          return;
        }

        setIsAiLoading(true);
        setAiError(null);
        setAiAnalysis(null);

        // Prepare summary data for prompt
        const summaryStats = {
          totalCost: stats.totalCost,
          totalDistance: stats.totalDistance,
          avgKml: stats.avgKml.toFixed(2),
          totalVehicles: chartVehicleKeys.length
        };

        // Get top 3 expensive cars
        const topSpenders = combinedStatsData
          .sort((a, b) => b.cost - a.cost)
          .slice(0, 3)
          .map(c => `${c.name} (${c.cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`);

        const prompt = `
                    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ (Fleet Manager Expert)
                    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ö‡∏≤‡∏ó):
                    - ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: ${summaryStats.totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó
                    - ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°: ${summaryStats.totalDistance.toLocaleString()} ‡∏Å‡∏°.
                    - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${summaryStats.avgKml} ‡∏Å‡∏°./‡∏•‡∏¥‡∏ï‡∏£
                    - ‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å: ${topSpenders.join(', ')}

                    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                    1. üìä **‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°**: ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
                    2. ‚ö†Ô∏è **‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á
                    3. üí° **‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢**: 3 ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
                    
                    ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏£‡∏¥‡πà‡∏ô‡∏ô‡∏≥
                `;

        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            })
          });

          if (!response.ok) throw new Error("AI Request Failed");

          const data = await response.json();
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å AI";
          setAiAnalysis(text);
        } catch (err) {
          console.error(err);
          setAiError("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key)");
        } finally {
          setIsAiLoading(false);
        }
      };

      if (loading) return (
        <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-slate-500">
          <RefreshCw className="animate-spin mb-4 text-blue-500" size={40} />
          <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet...</p>
        </div>
      );

      if (error) return (
        <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-red-500 p-4 text-center">
          <AlertCircle size={48} className="mb-4" />
          <p className="text-lg font-semibold">{error}</p>
        </div>
      );

      return (
        <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">

          {/* Header */}
          <header className="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                <Droplets className="text-blue-600" />
                Dashboard ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞
              </h1>
              <p className="text-slate-500 text-sm mt-1 flex items-center gap-2">
                <span className={`w-2 h-2 rounded-full ${isDemoMode ? 'bg-orange-500' : 'bg-green-500'}`}></span>
                {isDemoMode ? (
                  <span className="text-orange-600 font-medium">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)</span>
                ) : (
                  `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH', { dateStyle: 'long', timeStyle: 'short' })} ‡∏ô.`
                )}
              </p>
            </div>

            {/* Right Actions */}
            <div className="flex flex-wrap gap-2 items-center">

              {/* AI Button */}
              <button
                onClick={generateAiInsight}
                disabled={isAiLoading}
                className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center gap-2 text-sm font-medium disabled:opacity-70"
              >
                {isAiLoading ? <RefreshCw className="animate-spin" size={18} /> : <Sparkles size={18} />}
                {isAiLoading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...' : '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI'}
              </button>

              {/* Settings Button */}
              <button onClick={() => setShowSettings(!showSettings)} className="bg-white p-2 rounded-lg shadow-sm border border-slate-200 text-slate-500 hover:bg-slate-50">
                <Settings size={20} />
              </button>
            </div>
          </header>

          {/* Settings Panel */}
          {showSettings && (
            <div className="mb-6 p-4 bg-white border border-slate-200 rounded-xl shadow-sm animate-fade-in">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-semibold flex items-center gap-2 text-slate-700">
                  <Settings size={18} /> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </h3>
                <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600"><X size={18} /></button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-xs font-medium text-slate-500 mb-1">Gemini API Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå AI)</label>
                  <input
                    type="password"
                    value={userApiKey}
                    onChange={(e) => setUserApiKey(e.target.value)}
                    placeholder="‡∏ß‡∏≤‡∏á API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                    className="w-full text-sm border border-slate-300 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 outline-none"
                  />
                  <p className="text-xs text-slate-400 mt-1">Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Browser ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                </div>
                <hr className="border-slate-100" />
                <div className="text-xs text-slate-500">
                  <p>Version: 1.2.0 (AI Enabled)</p>
                </div>
              </div>
            </div>
          )}

          {/* Filters */}
          <div className="flex flex-wrap gap-2 items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200 mb-6">
            <div className="flex items-center gap-2 border-r border-slate-200 pr-2 mr-2">
              <Filter size={18} className="text-slate-400" />
            </div>
            <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="bg-transparent outline-none text-sm font-medium text-slate-700 p-1 hover:bg-slate-50 rounded cursor-pointer">
              <option value="All">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (All Years)</option>
              {years.map(y => <option key={y} value={y}>{y + 543}</option>)}
            </select>
            <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="bg-transparent outline-none text-sm font-medium text-slate-700 p-1 hover:bg-slate-50 rounded cursor-pointer">
              <option value="All">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (All Months)</option>
              {months.map(m => <option key={m} value={m}>{MONTH_NAMES[m]}</option>)}
            </select>
            <div className="h-4 w-[1px] bg-slate-200 mx-1"></div>
            <select value={selectedVehicle} onChange={(e) => setSelectedVehicle(e.target.value)} className="bg-transparent outline-none text-sm font-medium text-slate-700 min-w-[150px] p-1 hover:bg-slate-50 rounded cursor-pointer">
              {allVehiclesList.map(v => (
                <option key={v} value={v}>{v === 'All' ? '‡∏£‡∏ñ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô (All Vehicles)' : v}</option>
              ))}
            </select>
          </div>

          {/* AI Insight Result */}
          {aiAnalysis && (
            <div className="mb-8 p-1 ai-border shadow-md">
              <div className="bg-white rounded-xl p-6">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 ai-gradient-text">
                  <Sparkles size={24} className="text-purple-500" />
                  ‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI (AI Insights)
                </h3>
                <div className="prose prose-sm max-w-none text-slate-700" dangerouslySetInnerHTML={{ __html: marked.parse(aiAnalysis) }}></div>
              </div>
            </div>
          )}

          {aiError && (
            <div className="mb-8 bg-red-50 border border-red-200 text-red-600 p-4 rounded-xl flex items-center gap-3">
              <AlertCircle size={20} />
              {aiError}
            </div>
          )}

          {/* Stats Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <StatCard title="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°" value={`‡∏ø${stats.totalCost.toLocaleString(undefined, { maximumFractionDigits: 0 })}`} icon={<Wallet className="text-white" size={24} />} color="bg-red-500" />
            <StatCard title="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ß‡∏°" value={`${stats.totalLiters.toLocaleString(undefined, { maximumFractionDigits: 0 })} ‡∏•‡∏¥‡∏ï‡∏£`} icon={<Droplets className="text-white" size={24} />} color="bg-blue-500" />
            <StatCard title="‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏ß‡∏°" value={`${stats.totalDistance.toLocaleString()} ‡∏Å‡∏°.`} icon={<Car className="text-white" size={24} />} color="bg-emerald-500" note={stats.totalDistance === 0 ? "(‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)" : ""} />
            <StatCard title="‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢" value={`${stats.avgKml.toFixed(2)} ‡∏Å‡∏°./‡∏•‡∏¥‡∏ï‡∏£`} icon={<Gauge className="text-white" size={24} />} color="bg-amber-500" />
          </div>

          {/* Main Charts Area */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-2">
                <h3 className="text-lg font-semibold flex items-center gap-2">
                  <Gauge size={20} className="text-amber-500" />
                  ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (KM/L)
                </h3>
                {selectedVehicle === 'All' && (
                  <span className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">
                    *‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏¢‡∏Å)
                  </span>
                )}
              </div>
              <div className="h-[400px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  {monthlyEfficiencyData.length > 0 ? (
                    <BarChart data={monthlyEfficiencyData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
                      <XAxis dataKey="name" stroke="#64748b" tick={{ fontSize: 12 }} />
                      <YAxis stroke="#64748b" tick={{ fontSize: 12 }} domain={[0, 'auto']} />
                      <Tooltip cursor={{ fill: '#f8fafc' }} contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }} formatter={(value, name) => [`${value} km/L`, name]} />
                      <Legend verticalAlign="top" height={36} />
                      {chartVehicleKeys.map((vehicleName) => (
                        <Bar key={vehicleName} dataKey={vehicleName} name={vehicleName} fill={getVehicleColor(vehicleName)} radius={[4, 4, 0, 0]} />
                      ))}
                    </BarChart>
                  ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-400 gap-2">
                      <AlertCircle size={32} />
                      <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                    </div>
                  )}
                </ResponsiveContainer>
              </div>
            </div>

            {/* Cost Distribution (Top 5) - Changed to Bar Chart */}
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h3 className="text-lg font-semibold mb-2 flex items-center gap-2">
                <Wallet size={20} className="text-red-500" />
                ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (Top 5)
              </h3>
              <p className="text-xs text-slate-400 mb-4">*‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
              <div className="h-[365px] w-full">
                <ResponsiveContainer width="100%" height="100%">
                  {selectedVehicle === 'All' ? (
                    <BarChart
                      data={costByVehicleData}
                      layout="vertical"
                      margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                      <XAxis type="number" stroke="#64748b" tick={{ fontSize: 12 }} />
                      <YAxis
                        dataKey="name"
                        type="category"
                        stroke="#64748b"
                        tick={{ fontSize: 12, fontWeight: 500 }}
                        width={150}
                      />
                      <Tooltip
                        cursor={{ fill: '#f1f5f9' }}
                        contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }}
                        formatter={(value) => [`‡∏ø${value.toLocaleString()}`, '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢']}
                      />
                      <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={30}>
                        {costByVehicleData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Bar>
                    </BarChart>
                  ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-400">
                      <p>‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏ñ: <span className="text-slate-800 font-semibold">{selectedVehicle}</span></p>
                      <p className="text-3xl font-bold text-slate-800 mt-2">‡∏ø{stats.totalCost.toLocaleString()}</p>
                    </div>
                  )}
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          {/* Bottom Chart: Comparison with Tabs */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-4">
              <h3 className="text-lg font-semibold flex items-center gap-2 text-slate-800">
                {bottomTab === 'cost_dist' ? <TrendingUp size={20} className="text-blue-500" /> : <BarChart2 size={20} className="text-green-500" />}
                {bottomTab === 'cost_dist' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ vs ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á' : '‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (KM/L)'}
              </h3>

              {/* TABS */}
              <div className="flex bg-slate-100 p-1 rounded-lg">
                <button
                  onClick={() => setBottomTab('cost_dist')}
                  className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${bottomTab === 'cost_dist' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <TrendingUp size={16} /> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤
                </button>
                <button
                  onClick={() => setBottomTab('efficiency')}
                  className={`px-3 py-1.5 text-sm font-medium rounded-md transition-all flex items-center gap-2 ${bottomTab === 'efficiency' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <BarChart2 size={16} /> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î
                </button>
              </div>
            </div>

            <div className="h-[400px] w-full">
              <ResponsiveContainer width="100%" height="100%">
                {combinedStatsData.length > 0 ? (
                  bottomTab === 'cost_dist' ? (
                    // CHART 1: Cost vs Distance (Composed)
                    <ComposedChart data={combinedStatsData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                      <XAxis dataKey="name" stroke="#64748b" tick={{ fontSize: 12, fontWeight: 500 }} interval={0} height={60} angle={-15} textAnchor="end" />
                      <YAxis yAxisId="left" stroke="#3B82F6" orientation="left" tick={{ fontSize: 12 }} />
                      <YAxis yAxisId="right" stroke="#F97316" orientation="right" tick={{ fontSize: 12 }} />
                      <Tooltip
                        contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }}
                        formatter={(value, name) => {
                          if (name === 'cost') return [`‡∏ø${value.toLocaleString()}`, '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢'];
                          if (name === 'distance') return [`${value.toLocaleString()} ‡∏Å‡∏°.`, '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á'];
                          return [value, name];
                        }}
                        labelFormatter={(name, payload) => {
                          if (payload && payload.length > 0) {
                            const bpk = payload[0].payload.bpk;
                            return `${name} (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ‡∏ø${bpk}/‡∏Å‡∏°.)`;
                          }
                          return name;
                        }}
                      />
                      <Legend />
                      <Bar yAxisId="left" dataKey="cost" name="cost" fill="#3B82F6" barSize={35} radius={[4, 4, 0, 0]} />
                      <Line yAxisId="right" type="monotone" dataKey="distance" name="distance" stroke="#F97316" strokeWidth={4} dot={{ r: 5, fill: '#F97316' }} activeDot={{ r: 8 }} />
                    </ComposedChart>
                  ) : (
                    // CHART 2: Efficiency Rank (Bar Chart)
                    <BarChart data={combinedStatsData} layout="vertical" margin={{ top: 5, right: 30, left: 40, bottom: 5 }}>
                      <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                      <XAxis type="number" stroke="#64748b" tick={{ fontSize: 12 }} />
                      <YAxis
                        dataKey="name"
                        type="category"
                        stroke="#64748b"
                        tick={{ fontSize: 12, fontWeight: 500 }}
                        width={180}
                        interval={0}
                      />
                      <Tooltip
                        cursor={{ fill: '#f1f5f9' }}
                        contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }}
                        formatter={(value) => [`${value} km/L`, 'Fuel Efficiency']}
                      />
                      <Bar dataKey="kml" fill="#10B981" radius={[0, 4, 4, 0]} barSize={25}>
                        {combinedStatsData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.kml > 12 ? '#10B981' : entry.kml > 8 ? '#F59E0B' : '#EF4444'} />
                        ))}
                      </Bar>
                    </BarChart>
                  )
                ) : (
                  <div className="flex flex-col items-center justify-center h-full text-slate-400">
                    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                  </div>
                )}
              </ResponsiveContainer>
            </div>
          </div>

          {/* Data Table */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
            <div
              className="p-4 bg-slate-50 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-4 cursor-pointer hover:bg-slate-100 transition-colors"
            >
              <div className="flex items-center justify-between w-full sm:w-auto gap-4" onClick={() => setIsTableExpanded(!isTableExpanded)}>
                <h3 className="font-semibold text-slate-700 flex items-center gap-2">
                  <FileText size={18} />
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Data Logs)
                  <span className="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-200">
                    {searchedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </span>
                </h3>
                <button className="text-slate-500 sm:hidden">
                  {isTableExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
              </div>

              <div className="flex items-center gap-2 w-full sm:w-auto">
                {/* Search Bar */}
                <div className="relative w-full sm:w-64">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                  <input
                    type="text"
                    placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-9 pr-4 py-1.5 text-sm border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-100 w-full"
                  />
                </div>
                <button className="text-slate-500 hidden sm:block" onClick={() => setIsTableExpanded(!isTableExpanded)}>
                  {isTableExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
              </div>
            </div>

            {isTableExpanded && (
              <div className="flex flex-col">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left text-slate-600">
                    <thead className="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                      <tr>
                        <th className="px-6 py-3 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th className="px-6 py-3 whitespace-nowrap">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (Odo)</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">‡∏£‡∏∞‡∏¢‡∏∞‡∏ß‡∏¥‡πà‡∏á</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">‡∏•‡∏¥‡∏ï‡∏£</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">‡∏ö‡∏≤‡∏ó/‡∏•‡∏¥‡∏ï‡∏£</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</th>
                        <th className="px-6 py-3 text-right whitespace-nowrap">KM/L</th>
                      </tr>
                    </thead>
                    <tbody>
                      {currentTableData.map((row) => (
                        <tr key={row.id} className="bg-white border-b hover:bg-slate-50">
                          <td className="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">{row.date}</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-2">
                              <span className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: getVehicleColor(row.vehicle) }}></span>
                              {row.vehicle}
                            </div>
                          </td>
                          <td className="px-6 py-4 text-right">{row.odometer.toLocaleString()}</td>
                          <td className="px-6 py-4 text-right text-emerald-600 font-medium">
                            {row.distance > 0 ? row.distance.toLocaleString() : '-'}
                          </td>
                          <td className="px-6 py-4 text-right">{row.liters}</td>
                          <td className="px-6 py-4 text-right">{row.pricePerLiter}</td>
                          <td className="px-6 py-4 text-right font-bold text-slate-800">{row.cost.toLocaleString()}</td>
                          <td className="px-6 py-4 text-right">
                            {row.distance > 0 && row.kml > 0 ? (
                              <span className={`px-2 py-1 rounded-full text-xs font-semibold ${row.kml > 15 ? 'bg-green-100 text-green-800' :
                                row.kml > 10 ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800'
                                }`}>
                                {row.kml}
                              </span>
                            ) : <span className="text-slate-300">-</span>}
                          </td>
                        </tr>
                      ))}
                      {currentTableData.length === 0 && (
                        <tr>
                          <td colSpan="8" className="px-6 py-8 text-center text-slate-400">
                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>

                {/* Pagination Controls */}
                {totalPages > 1 && (
                  <div className="flex items-center justify-between px-6 py-4 border-t border-slate-200 bg-slate-50">
                    <div className="text-xs text-slate-500">
                      ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ <span className="font-semibold">{currentPage}</span> ‡∏à‡∏≤‡∏Å <span className="font-semibold">{totalPages}</span>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => goToPage(currentPage - 1)}
                        disabled={currentPage === 1}
                        className="px-3 py-1 text-xs font-medium rounded-md border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                      </button>
                      <button
                        onClick={() => goToPage(currentPage + 1)}
                        disabled={currentPage === totalPages}
                        className="px-3 py-1 text-xs font-medium rounded-md border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                      </button>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Debug Footer */}
          <div className="mt-8 border-t border-slate-200 pt-4">
            <button onClick={() => setShowDebug(!showDebug)} className="flex items-center gap-2 text-xs text-slate-400 hover:text-slate-600 transition-colors">
              <Settings size={14} />
              {showDebug ? "‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Debug (Hide Debug)" : "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•? ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Debug Mapping)"}
            </button>
            {showDebug && mappingDebug && (
              <div className="mt-4 p-4 bg-slate-800 text-slate-200 rounded-lg text-xs font-mono overflow-x-auto">
                <h4 className="font-bold mb-2 text-white flex items-center gap-2"><CheckCircle2 size={14} className="text-green-400" /> CSV Column Mapping Status</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-slate-400 mb-1">Found Headers in CSV:</p>
                    <div className="flex flex-wrap gap-2">{mappingDebug.headers.map((h, i) => (
                      <span key={i} className="px-2 py-1 bg-slate-700 rounded border border-slate-600">[{i}] {h}</span>
                    ))}</div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-1">Active Mapping:</p>
                    <ul className="space-y-1">{Object.entries(mappingDebug.mapping).map(([key, val]) => (
                      <li key={key} className="flex justify-between border-b border-slate-700 pb-1">
                        <span className="text-blue-300 capitalize">{key}</span>
                        <span>Col <span className="text-yellow-400 font-bold">{val.index}</span>: {val.name}</span>
                      </li>
                    ))}</ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function StatCard({ title, value, icon, color, note }) {
      return (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between transition-transform hover:-translate-y-1 duration-200">
          <div>
            <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
            <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
            {note && <p className="text-xs text-red-400 mt-1">{note}</p>}
          </div>
          <div className={`p-3 rounded-lg shadow-sm ${color}`}>{icon}</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>