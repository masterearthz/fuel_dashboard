<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Consumption Dashboard</title>
    
    <!-- Fix global reference for some UMD builds -->
    <script>
        window.global = window;
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts (Stable UMD) -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
    </style>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts;

        // --- Inline Icons (Lucide) ---
        // ใช้ Inline SVG แทนการ Import เพื่อลดปัญหา CDN Error
        const Icon = ({ children, color = "currentColor", size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Car = (props) => <Icon {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></Icon>;
        const Droplets = (props) => <Icon {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></Icon>;
        const Wallet = (props) => <Icon {...props}><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></Icon>;
        const Gauge = (props) => <Icon {...props}><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></Icon>;
        const Calendar = (props) => <Icon {...props}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></Icon>;
        const Filter = (props) => <Icon {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>;
        const ChevronDown = (props) => <Icon {...props}><path d="m6 9 6 6 6-6"/></Icon>;
        const ChevronUp = (props) => <Icon {...props}><path d="m18 15-6-6-6 6"/></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>;
        const CheckCircle2 = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const ListOrdered = (props) => <Icon {...props}><line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>;

        // --- Constants & Config ---
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_CbtEgFdOUWga3qSQq2hjdWgFIOTWVsGEK0ZdejWSLGb01td_JC7uITqtWQwLqXswGJcMqCSZpT0j/pub?gid=0&single=true&output=csv";
        
        // Mock Data for Fallback (Use Thai Headers to match parser logic)
        const MOCK_CSV = `วันที่เติม,ทะเบียนรถ,เลขไมล์เติมน้ำม้น,จำนวนลิตร,จำนวนเงินที่เติม,ราคา/ลิตร
01/01/2567,Toyota Camry (กก-1234),120000,45.5,1600,35.16
05/01/2567,Honda CR-V (ขข-5678),55000,52.0,1900,36.54
10/01/2567,Toyota Camry (กก-1234),120600,42.0,1500,35.71
15/01/2567,Isuzu D-Max (คค-9999),80000,60.0,2100,35.00
20/01/2567,Honda CR-V (ขข-5678),55600,48.0,1750,36.46
25/01/2567,Toyota Camry (กก-1234),121100,38.0,1350,35.53
01/02/2567,Isuzu D-Max (คค-9999),80800,55.0,1950,35.45
05/02/2567,Toyota Camry (กก-1234),121650,44.0,1580,35.91
10/02/2567,Honda CR-V (ขข-5678),56200,50.0,1820,36.40
15/02/2567,Isuzu D-Max (คค-9999),81600,62.0,2200,35.48
20/02/2567,Toyota Camry (กก-1234),122200,40.0,1450,36.25
25/02/2567,Honda CR-V (ขข-5678),56800,51.0,1880,36.86
01/03/2567,Isuzu D-Max (คค-9999),82500,65.0,2300,35.38
05/03/2567,Toyota Camry (กก-1234),122700,41.0,1500,36.59
10/03/2567,Honda CR-V (ขข-5678),57400,49.0,1800,36.73`;

        const COLORS = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', 
            '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#A855F7', '#64748B'
        ];

        const MONTH_NAMES = [
            "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", 
            "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
        ];

        // --- Utility Functions ---
        const splitCSV = (str) => {
            const result = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < str.length; i++) {
                const char = str[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            const d = new Date(dateStr);
            if (!isNaN(d.getTime()) && dateStr.includes('-')) return d;

            const parts = dateStr.split(/[\/\-\.]/);
            if (parts.length === 3) {
                let year = parseInt(parts[2]);
                if (year > 2500) year -= 543;
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[0]);
                const thaiDate = new Date(year, month, day);
                if (!isNaN(thaiDate.getTime())) return thaiDate;
            }
            return d;
        };

        const cleanNumber = (str) => {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            const cleaned = str.toString().replace(/,/g, '').replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        };

        // --- Main Component ---
        function App() {
            const [rawData, setRawData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Filters State
            const [selectedVehicle, setSelectedVehicle] = useState('All');
            const [selectedYear, setSelectedYear] = useState('All');
            const [selectedMonth, setSelectedMonth] = useState('All');
            const [isDemoMode, setIsDemoMode] = useState(false);

            const [isTableExpanded, setIsTableExpanded] = useState(false);
            
            // Debug State
            const [mappingDebug, setMappingDebug] = useState(null);
            const [showDebug, setShowDebug] = useState(false);

            useEffect(() => {
                const processData = (text) => {
                    try {
                        const lines = text.split(/\r?\n/);
                        if (lines.length < 2) throw new Error("CSV file is empty or invalid format");

                        const headerLine = lines[0];
                        const headers = splitCSV(headerLine).map(h => h.trim());
                        const headersLower = headers.map(h => h.toLowerCase());
                        
                        const findIdx = (keywords, excludes = []) => {
                            return headersLower.findIndex(h => 
                                keywords.some(k => h.includes(k)) && 
                                !excludes.some(e => h.includes(e))
                            );
                        };

                        // Mapping Logic
                        let dateIdx = findIdx(['วันที่เติม']);
                        let vehicleIdx = findIdx(['ทะเบียนรถ']);
                        let odoIdx = findIdx(['เลขไมล์เติมน้ำม้น']);
                        let literIdx = findIdx(['จำนวนลิตร']);
                        let costIdx = findIdx(['จำนวนเงินที่เติม']);
                        let pricePerLiterIdx = findIdx(['ราคา/ลิตร']);

                        // Fallback Mapping Logic
                        if (dateIdx === -1) dateIdx = findIdx(['date', 'time', 'วัน', 'เวลา']);
                        if (vehicleIdx === -1) vehicleIdx = findIdx(['vehicle', 'car', 'plate', 'ทะเบียน', 'รถ']);
                        if (odoIdx === -1) odoIdx = findIdx(['odo', 'mile', 'ไมล์', 'ระยะ', 'กิโล']);
                        if (literIdx === -1) literIdx = findIdx(['liter', 'vol', 'ลิตร', 'ปริมาณ']);
                        if (costIdx === -1) costIdx = findIdx(['cost', 'price', 'baht', 'บาท', 'จำนวนเงิน', 'ราคา'], ['ต่อ', '/']);
                        
                        if (dateIdx === -1) dateIdx = 0;
                        if (vehicleIdx === -1) vehicleIdx = 1;
                        if (odoIdx === -1) odoIdx = 2;
                        if (literIdx === -1) literIdx = 3; 
                        if (costIdx === -1) costIdx = 4;

                        setMappingDebug({
                            headers: headers,
                            mapping: {
                                date: { index: dateIdx, name: headers[dateIdx] || 'N/A' },
                                vehicle: { index: vehicleIdx, name: headers[vehicleIdx] || 'N/A' },
                                odometer: { index: odoIdx, name: headers[odoIdx] || 'N/A' },
                                liters: { index: literIdx, name: headers[literIdx] || 'N/A' },
                                cost: { index: costIdx, name: headers[costIdx] || 'N/A' },
                                pricePerLiter: { index: pricePerLiterIdx, name: headers[pricePerLiterIdx] || 'N/A' }
                            }
                        });

                        const parsedData = lines.slice(1).map((line, index) => {
                            if (!line.trim()) return null;
                            const row = splitCSV(line);
                            if (row.length < 3) return null;

                            const dateStr = row[dateIdx] || '';
                            const dateObj = parseDate(dateStr);
                            const vehicleStr = (row[vehicleIdx] || 'Unknown').trim();
                            const odoVal = cleanNumber(row[odoIdx]);
                            const literVal = cleanNumber(row[literIdx]);
                            const costVal = cleanNumber(row[costIdx]);
                            
                            let pplVal = 0;
                            if (pricePerLiterIdx !== -1) {
                                pplVal = cleanNumber(row[pricePerLiterIdx]);
                            } else if (literVal > 0) {
                                pplVal = costVal / literVal;
                            }

                            const formattedDate = dateObj 
                                ? dateObj.toLocaleDateString('th-TH', { year: '2-digit', month: '2-digit', day: '2-digit' })
                                : dateStr;
                                
                            const timestamp = dateObj ? dateObj.getTime() : 0;

                            return {
                                id: index,
                                rawDate: dateStr,
                                date: formattedDate,
                                timestamp: timestamp,
                                vehicle: vehicleStr,
                                odometer: odoVal,
                                liters: literVal,
                                cost: costVal,
                                pricePerLiter: parseFloat(pplVal.toFixed(2))
                            };
                        }).filter(item => item && item.liters > 0); 

                        setRawData(parsedData);
                        setLoading(false);
                        return true;
                    } catch (err) {
                        console.error("Processing error:", err);
                        return false;
                    }
                };

                const fetchData = async () => {
                    try {
                        setLoading(true);
                        
                        // 1. ลองเชื่อมต่อโดยตรง (Direct Fetch)
                        let response;
                        try {
                            response = await fetch(CSV_URL);
                        } catch (e) {
                            console.warn("Direct fetch failed (likely CORS/307), attempting Proxy...");
                        }

                        // 2. ถ้าต่อตรงไม่ได้ ให้ลองใช้ CORS Proxy
                        if (!response || !response.ok) {
                            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(CSV_URL)}`;
                            response = await fetch(proxyUrl);
                        }

                        if (!response.ok) throw new Error('Network response was not ok');
                        const text = await response.text();
                        const success = processData(text);
                        if (!success) throw new Error("Parsing failed");
                        setIsDemoMode(false);
                    } catch (err) {
                        console.warn("Fetch failed, falling back to mock data:", err);
                        // 3. ถ้าไม่ได้จริงๆ ใช้ข้อมูลจำลอง (Fallback to MOCK_CSV)
                        setIsDemoMode(true);
                        setError(null); // เคลียร์ Error เพราะเราจัดการด้วยข้อมูลจำลองแล้ว
                        processData(MOCK_CSV);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();
            }, []);

            // --- Logic ---
            const processedData = useMemo(() => {
                const groupedByVehicle = {};
                rawData.forEach(item => {
                    if (!groupedByVehicle[item.vehicle]) groupedByVehicle[item.vehicle] = [];
                    groupedByVehicle[item.vehicle].push(item);
                });

                let allProcessed = [];

                Object.keys(groupedByVehicle).forEach(v => {
                    const validOdoEntries = groupedByVehicle[v].filter(d => d.odometer > 0).sort((a, b) => a.odometer - b.odometer);
                    
                    const calculated = validOdoEntries.map((entry, index) => {
                        let distance = 0;
                        let kml = 0;

                        if (index > 0) {
                            const prevEntry = validOdoEntries[index - 1];
                            distance = entry.odometer - prevEntry.odometer;
                            if (distance < 0) distance = 0; 
                            
                            if (entry.liters > 0 && distance > 0) {
                                kml = distance / entry.liters;
                            }
                        }

                        return { ...entry, distance, kml: parseFloat(kml.toFixed(2)) };
                    });

                    allProcessed = [...allProcessed, ...calculated];
                });

                return allProcessed.sort((a, b) => a.timestamp - b.timestamp);
            }, [rawData]);

            const { years, months } = useMemo(() => {
                const ySet = new Set();
                const mSet = new Set();
                rawData.forEach(d => {
                    if (d.timestamp) {
                        const date = new Date(d.timestamp);
                        ySet.add(date.getFullYear());
                        mSet.add(date.getMonth());
                    }
                });
                return {
                    years: Array.from(ySet).sort((a, b) => b - a),
                    months: Array.from(mSet).sort((a, b) => a - b)
                };
            }, [rawData]);

            const filteredData = useMemo(() => {
                let data = processedData;
                if (selectedVehicle !== 'All') {
                    data = data.filter(d => d.vehicle === selectedVehicle);
                }
                if (selectedYear !== 'All') {
                    data = data.filter(d => {
                        const date = new Date(d.timestamp);
                        return date.getFullYear() === parseInt(selectedYear);
                    });
                }
                if (selectedMonth !== 'All') {
                    data = data.filter(d => {
                        const date = new Date(d.timestamp);
                        return date.getMonth() === parseInt(selectedMonth);
                    });
                }
                return data;
            }, [processedData, selectedVehicle, selectedYear, selectedMonth]);

            const monthlyEfficiencyData = useMemo(() => {
                const groups = {}; 
                filteredData.forEach(item => {
                    if (item.distance <= 0 || item.liters <= 0) return;
                    const dateObj = new Date(item.timestamp);
                    if (isNaN(dateObj.getTime())) return;

                    const monthKey = dateObj.toLocaleDateString('th-TH', { month: 'short', year: '2-digit' });
                    const sortKey = dateObj.getFullYear() * 100 + dateObj.getMonth();

                    if (!groups[monthKey]) groups[monthKey] = { name: monthKey, sortKey: sortKey, vehicles: {} };

                    const vName = item.vehicle;
                    if (!groups[monthKey].vehicles[vName]) groups[monthKey].vehicles[vName] = { distance: 0, liters: 0 };

                    groups[monthKey].vehicles[vName].distance += item.distance;
                    groups[monthKey].vehicles[vName].liters += item.liters;
                });

                const result = Object.values(groups).map(group => {
                    const row = { name: group.name, sortKey: group.sortKey };
                    Object.keys(group.vehicles).forEach(v => {
                        const { distance, liters } = group.vehicles[v];
                        row[v] = liters > 0 ? parseFloat((distance / liters).toFixed(2)) : 0;
                    });
                    return row;
                });
                return result.sort((a, b) => a.sortKey - b.sortKey);
            }, [filteredData]);

            const chartVehicleKeys = useMemo(() => {
                const keys = new Set();
                monthlyEfficiencyData.forEach(d => {
                    Object.keys(d).forEach(k => {
                        if (k !== 'name' && k !== 'sortKey') keys.add(k);
                    });
                });
                return Array.from(keys);
            }, [monthlyEfficiencyData]);

            const allVehiclesList = useMemo(() => {
                return ['All', ...new Set(rawData.map(d => d.vehicle))];
            }, [rawData]);

            const getVehicleColor = (vehicleName) => {
                const index = allVehiclesList.indexOf(vehicleName);
                return COLORS[index % COLORS.length] || '#000';
            };

            const stats = useMemo(() => {
                const totalCost = filteredData.reduce((acc, curr) => acc + curr.cost, 0);
                const totalLiters = filteredData.reduce((acc, curr) => acc + curr.liters, 0);
                const totalDistance = filteredData.reduce((acc, curr) => acc + curr.distance, 0);
                const validRuns = filteredData.filter(d => d.distance > 0);
                const validRunLiters = validRuns.reduce((acc, curr) => acc + curr.liters, 0);
                const validDist = validRuns.reduce((acc, curr) => acc + curr.distance, 0);
                const avgKml = validRunLiters > 0 ? (validDist / validRunLiters) : 0;
                return { totalCost, totalLiters, totalDistance, avgKml };
            }, [filteredData]);

            const costByVehicleData = useMemo(() => {
                const costMap = {};
                rawData.forEach(d => {
                    const vName = d.vehicle || 'Unknown';
                    if (!costMap[vName]) costMap[vName] = 0;
                    costMap[vName] += d.cost;
                });
                
                let data = Object.keys(costMap)
                    .map(key => ({ name: key, value: costMap[key] }))
                    .sort((a, b) => b.value - a.value);

                if (data.length > 6) {
                    const topItems = data.slice(0, 5);
                    const otherItems = data.slice(5);
                    const otherValue = otherItems.reduce((sum, item) => sum + item.value, 0);
                    data = [...topItems, { name: `อื่นๆ (${otherItems.length} คัน)`, value: otherValue }];
                }
                return data;
            }, [rawData]);

            const rankedCostData = useMemo(() => {
                const costMap = {};
                filteredData.forEach(d => {
                    const vName = d.vehicle || 'Unknown';
                    if (!costMap[vName]) costMap[vName] = 0;
                    costMap[vName] += d.cost;
                });
                return Object.keys(costMap)
                    .map(key => ({ name: key, value: costMap[key] }))
                    .sort((a, b) => b.value - a.value);
            }, [filteredData]);

            // --- Render ---
            if (loading) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-slate-500">
                    <RefreshCw className="animate-spin mb-4 text-blue-500" size={40} />
                    <p>กำลังเชื่อมต่อ Google Sheet...</p>
                </div>
            );

            if (error) return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-red-500 p-4 text-center">
                    <AlertCircle size={48} className="mb-4" />
                    <p className="text-lg font-semibold">{error}</p>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">
                    
                    {/* Header */}
                    <header className="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                <Droplets className="text-blue-600" />
                                Dashboard การใช้น้ำมันยานพาหนะ
                            </h1>
                            <p className="text-slate-500 text-sm mt-1 flex items-center gap-2">
                                <span className={`w-2 h-2 rounded-full ${isDemoMode ? 'bg-orange-500' : 'bg-green-500'}`}></span>
                                {isDemoMode ? (
                                    <span className="text-orange-600 font-medium">แสดงข้อมูลตัวอย่าง (เชื่อมต่อ Google Sheet ไม่สำเร็จ)</span>
                                ) : (
                                    `ข้อมูลอัปเดตล่าสุด: ${new Date().toLocaleString('th-TH', { dateStyle: 'long', timeStyle: 'short' })} น.`
                                )}
                            </p>
                        </div>
                        
                        {/* Filters */}
                        <div className="flex flex-wrap gap-2 items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                            <div className="flex items-center gap-2 border-r border-slate-200 pr-2 mr-2">
                                <Filter size={18} className="text-slate-400" />
                            </div>

                            <select 
                                value={selectedYear}
                                onChange={(e) => setSelectedYear(e.target.value)}
                                className="bg-transparent outline-none text-sm font-medium text-slate-700 p-1 hover:bg-slate-50 rounded cursor-pointer"
                            >
                                <option value="All">ทุกปี (All Years)</option>
                                {years.map(y => <option key={y} value={y}>{y + 543}</option>)}
                            </select>

                            <select 
                                value={selectedMonth}
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="bg-transparent outline-none text-sm font-medium text-slate-700 p-1 hover:bg-slate-50 rounded cursor-pointer"
                            >
                                <option value="All">ทุกเดือน (All Months)</option>
                                {months.map(m => <option key={m} value={m}>{MONTH_NAMES[m]}</option>)}
                            </select>
                            
                            <div className="h-4 w-[1px] bg-slate-200 mx-1"></div>

                            <select 
                                value={selectedVehicle}
                                onChange={(e) => setSelectedVehicle(e.target.value)}
                                className="bg-transparent outline-none text-sm font-medium text-slate-700 min-w-[150px] p-1 hover:bg-slate-50 rounded cursor-pointer"
                            >
                                {allVehiclesList.map(v => (
                                <option key={v} value={v}>{v === 'All' ? 'รถทุกคัน (All Vehicles)' : v}</option>
                                ))}
                            </select>
                        </div>
                    </header>
                    
                    {/* Demo Mode Alert */}
                    {isDemoMode && (
                        <div className="mb-6 p-3 bg-orange-50 border border-orange-200 rounded-lg flex items-center gap-3 text-orange-700 text-sm">
                            <Info size={20} className="text-orange-500 flex-shrink-0" />
                            <div>
                                <p className="font-semibold">กำลังใช้งานโหมด Demo</p>
                                <p>ระบบไม่สามารถดึงข้อมูลจาก Google Sheet ได้ (อาจเกิดจากสิทธิ์การเข้าถึงหรือปัญหาเครือข่าย) จึงแสดงข้อมูลจำลองแทน</p>
                            </div>
                        </div>
                    )}

                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <StatCard title="ค่าใช้จ่ายรวม" value={`฿${stats.totalCost.toLocaleString(undefined, {maximumFractionDigits: 0})}`} icon={<Wallet className="text-white" size={24} />} color="bg-red-500" />
                        <StatCard title="ปริมาณน้ำมันรวม" value={`${stats.totalLiters.toLocaleString(undefined, {maximumFractionDigits: 0})} ลิตร`} icon={<Droplets className="text-white" size={24} />} color="bg-blue-500" />
                        <StatCard title="ระยะทางวิ่งรวม" value={`${stats.totalDistance.toLocaleString()} กม.`} icon={<Car className="text-white" size={24} />} color="bg-emerald-500" note={stats.totalDistance === 0 ? "(ต้องการข้อมูลเลขไมล์อย่างน้อย 2 ครั้ง)" : ""} />
                        <StatCard title="อัตราสิ้นเปลืองเฉลี่ย" value={`${stats.avgKml.toFixed(2)} กม./ลิตร`} icon={<Gauge className="text-white" size={24} />} color="bg-amber-500" />
                    </div>

                    {/* Main Charts Area */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                                <Gauge size={20} className="text-amber-500" />
                                ประสิทธิภาพเฉลี่ยรายเดือน (KM/L)
                            </h3>
                            <div className="h-[400px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    {monthlyEfficiencyData.length > 0 ? (
                                        <BarChart data={monthlyEfficiencyData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
                                            <XAxis dataKey="name" stroke="#64748b" tick={{fontSize: 12}} />
                                            <YAxis stroke="#64748b" tick={{fontSize: 12}} domain={[0, 'auto']} />
                                            <Tooltip 
                                                cursor={{fill: '#f8fafc'}}
                                                contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }} 
                                                formatter={(value, name) => [`${value} km/L`, name]}
                                            />
                                            <Legend verticalAlign="top" height={36}/>
                                            {chartVehicleKeys.map((vehicleName) => (
                                                <Bar 
                                                    key={vehicleName}
                                                    dataKey={vehicleName} 
                                                    name={vehicleName}
                                                    fill={getVehicleColor(vehicleName)} 
                                                    radius={[4, 4, 0, 0]}
                                                />
                                            ))}
                                        </BarChart>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-400 gap-2">
                                            <AlertCircle size={32} />
                                            <p>ไม่พบข้อมูลตามช่วงเวลาที่เลือก</p>
                                        </div>
                                    )}
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="text-lg font-semibold mb-2 flex items-center gap-2">
                                <Wallet size={20} className="text-red-500" />
                                สัดส่วนค่าใช้จ่าย (Top 5)
                            </h3>
                            <p className="text-xs text-slate-400 mb-4">*คำนวณจากข้อมูลทั้งหมด ไม่ขึ้นกับตัวกรองเวลา</p>
                            <div className="h-[365px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    {selectedVehicle === 'All' ? (
                                        <PieChart>
                                            <Pie 
                                                data={costByVehicleData} 
                                                cx="50%" 
                                                cy="45%" 
                                                innerRadius={60} 
                                                outerRadius={90} 
                                                paddingAngle={2} 
                                                dataKey="value"
                                            >
                                                {costByVehicleData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                            </Pie>
                                            <Tooltip formatter={(value) => `฿${value.toLocaleString()}`} />
                                            <Legend 
                                                layout="horizontal" 
                                                verticalAlign="bottom" 
                                                align="center"
                                                wrapperStyle={{ paddingTop: '20px', fontSize: '12px' }} 
                                            />
                                        </PieChart>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                            <p>แสดงข้อมูลเฉพาะรถ: <span className="text-slate-800 font-semibold">{selectedVehicle}</span></p>
                                            <p className="text-3xl font-bold text-slate-800 mt-2">฿{stats.totalCost.toLocaleString()}</p>
                                        </div>
                                    )}
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* Bottom Chart */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                        <h3 className="text-lg font-semibold mb-6 flex items-center gap-2">
                            <ListOrdered size={20} className="text-blue-500" />
                            อันดับค่าใช้จ่ายรวม (เรียงจากมากไปน้อย)
                        </h3>
                        <div className="h-[400px] w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                {rankedCostData.length > 0 ? (
                                    <BarChart 
                                        data={rankedCostData} 
                                        layout="vertical"
                                        margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
                                    >
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e2e8f0" />
                                        <XAxis 
                                            type="number" 
                                            stroke="#64748b" 
                                            tick={{fontSize: 12}} 
                                            tickFormatter={(val) => `฿${val.toLocaleString()}`}
                                        />
                                        <YAxis 
                                            dataKey="name" 
                                            type="category" 
                                            stroke="#64748b" 
                                            tick={{fontSize: 12, fontWeight: 500}} 
                                            width={180}
                                            interval={0}
                                        />
                                        <Tooltip 
                                            cursor={{fill: '#f1f5f9'}}
                                            contentStyle={{ backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0' }} 
                                            formatter={(value) => [`฿${value.toLocaleString()}`, 'Total Cost']}
                                        />
                                        <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={30}>
                                            {rankedCostData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={getVehicleColor(entry.name)} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-400">
                                        <p>ไม่พบข้อมูล</p>
                                    </div>
                                )}
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* Data Table */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        <div 
                            className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors"
                            onClick={() => setIsTableExpanded(!isTableExpanded)}
                        >
                            <h3 className="font-semibold text-slate-700 flex items-center gap-2">
                                ข้อมูลดิบ (Data Logs)
                                <span className="text-xs font-normal text-slate-400 bg-white px-2 py-0.5 rounded-full border border-slate-200">
                                    {filteredData.length} รายการ
                                </span>
                            </h3>
                            <button className="text-slate-500">
                                {isTableExpanded ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                            </button>
                        </div>

                        {isTableExpanded && (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th className="px-6 py-3">วันที่</th>
                                            <th className="px-6 py-3">ทะเบียนรถ</th>
                                            <th className="px-6 py-3 text-right">เลขไมล์ (Odo)</th>
                                            <th className="px-6 py-3 text-right">ระยะวิ่ง</th>
                                            <th className="px-6 py-3 text-right">ลิตร</th>
                                            <th className="px-6 py-3 text-right">บาท/ลิตร</th>
                                            <th className="px-6 py-3 text-right">รวมเงิน</th>
                                            <th className="px-6 py-3 text-right">KM/L</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredData.map((row) => (
                                            <tr key={row.id} className="bg-white border-b hover:bg-slate-50">
                                                <td className="px-6 py-4 font-medium text-slate-900">{row.date}</td>
                                                <td className="px-6 py-4">{row.vehicle}</td>
                                                <td className="px-6 py-4 text-right">{row.odometer.toLocaleString()}</td>
                                                <td className="px-6 py-4 text-right text-emerald-600">{row.distance > 0 ? row.distance.toLocaleString() : '-'}</td>
                                                <td className="px-6 py-4 text-right">{row.liters}</td>
                                                <td className="px-6 py-4 text-right">{row.pricePerLiter}</td>
                                                <td className="px-6 py-4 text-right font-bold text-slate-800">{row.cost.toLocaleString()}</td>
                                                <td className="px-6 py-4 text-right">
                                                    {row.distance > 0 && row.kml > 0 ? (
                                                        <span className={`px-2 py-1 rounded-full text-xs font-semibold ${row.kml > 15 ? 'bg-green-100 text-green-800' : row.kml > 10 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                            {row.kml}
                                                        </span>
                                                    ) : '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    {/* Debug Footer */}
                    <div className="mt-8 border-t border-slate-200 pt-4">
                        <button 
                            onClick={() => setShowDebug(!showDebug)}
                            className="flex items-center gap-2 text-xs text-slate-400 hover:text-slate-600 transition-colors"
                        >
                            <Settings size={14} />
                            {showDebug ? "ซ่อนข้อมูล Debug (Hide Debug)" : "มีปัญหาข้อมูล? คลิกเพื่อดูการเชื่อมต่อ (Debug Mapping)"}
                        </button>
                        
                        {showDebug && mappingDebug && (
                            <div className="mt-4 p-4 bg-slate-800 text-slate-200 rounded-lg text-xs font-mono overflow-x-auto">
                                <h4 className="font-bold mb-2 text-white flex items-center gap-2">
                                    <CheckCircle2 size={14} className="text-green-400"/> CSV Column Mapping Status
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-slate-400 mb-1">Found Headers in CSV:</p>
                                        <div className="flex flex-wrap gap-2">
                                            {mappingDebug.headers.map((h, i) => (
                                                <span key={i} className="px-2 py-1 bg-slate-700 rounded border border-slate-600">
                                                    [{i}] {h}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <p className="text-slate-400 mb-1">Active Mapping:</p>
                                        <ul className="space-y-1">
                                            {Object.entries(mappingDebug.mapping).map(([key, val]) => (
                                                <li key={key} className="flex justify-between border-b border-slate-700 pb-1">
                                                    <span className="text-blue-300 capitalize">{key}</span>
                                                    <span>
                                                        Col <span className="text-yellow-400 font-bold">{val.index}</span>: {val.name}
                                                    </span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                </div>
            );
        }

        function StatCard({ title, value, icon, color, note }) {
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between transition-transform hover:-translate-y-1 duration-200">
                    <div>
                        <p className="text-sm font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800">{value}</h3>
                        {note && <p className="text-xs text-red-400 mt-1">{note}</p>}
                    </div>
                    <div className={`p-3 rounded-lg shadow-sm ${color}`}>{icon}</div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>